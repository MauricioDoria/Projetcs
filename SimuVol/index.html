<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simulador Mobile</title>
    <style>
        body { 
            background-color: #1a1a1a; 
            margin: 0; 
            overflow: hidden; 
            touch-action: none; 
            font-family: sans-serif;
            color: white;
        }

        /* Container Principal */
        #app {
            display: flex;
            width: 100vw;
            height: 100vh;
            transition: all 0.3s;
        }

        /* Modos de visualização */
        .horizontal { flex-direction: row; }
        .vertical { flex-direction: column-reverse; }

        /* Áreas */
        #area-volante { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: #222;
            position: relative;
        }
        
        #area-pedais { 
            flex: 1; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            background: #1a1a1a;
        }

        /* --- VISUAL DO VOLANTE --- */
        #volante-base {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle, #333 40%, #000 60%, #111 70%);
            border: 15px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Faixa Vermelha (Centro) */
        #marcador {
            position: absolute;
            top: -15px;
            width: 20px;
            height: 40px;
            background-color: #d32f2f;
            border-radius: 4px;
            z-index: 10;
        }
        /* Centro do volante (Logo/Cubo) */
        #cubo {
            width: 80px;
            height: 80px;
            background: #555;
            border-radius: 50%;
            border: 2px solid #777;
            z-index: 5;
        }
        /* Raios do volante */
        .raio {
            position: absolute;
            background: #222;
            z-index: 2;
        }
        .raio.horizontal { width: 100%; height: 40px; }
        .raio.vertical { height: 50%; width: 40px; bottom: 0; }

        /* Info de Graus */
        #info-graus {
            position: absolute;
            bottom: 20px;
            font-size: 1.2rem;
            color: #888;
        }

        /* --- PEDAIS --- */
        .pedal { 
            width: 35%; 
            height: 70%; 
            border-radius: 15px; 
            border: 4px solid #444;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.5rem;
            text-transform: uppercase;
            transition: transform 0.1s;
        }
        #freio { background: linear-gradient(to bottom, #b71c1c, #d32f2f); box-shadow: 0 10px 0 #7f0000; }
        #acelerador { background: linear-gradient(to bottom, #1b5e20, #388e3c); box-shadow: 0 10px 0 #003300; }
        
        .pressionado { 
            transform: translateY(10px); 
            box-shadow: 0 0 0 !important; 
            opacity: 0.8;
        }

        /* --- BOTÃO DE MUDAR TELA --- */
        #btn-layout {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }

    </style>
</head>
<body>

    <button id="btn-layout" onclick="mudarLayout()">Girar Tela ⟳</button>

    <div id="app" class="horizontal">
        <div id="area-volante">
            <div id="volante-base">
                <div id="marcador"></div>
                <div class="raio horizontal"></div>
                <div class="raio vertical"></div>
                <div id="cubo"></div>
            </div>
            <div id="info-graus">0°</div>
        </div>

        <div id="area-pedais">
            <div id="freio" class="pedal">Freio</div>     
            <div id="acelerador" class="pedal">Acel.</div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO
        const IP_DO_PC = "123.456.7.89"; // <--- COLOQUE SEU IP AQUI
        const ws = new WebSocket(`ws://${IP_DO_PC}:8765`);

        // Elementos
        const app = document.getElementById('app');
        const volanteVisual = document.getElementById('volante-base');
        const textoGraus = document.getElementById('info-graus');
        const areaVolante = document.getElementById('area-volante');
        
        // Variáveis de Lógica de Rotação
        let anguloTotal = 0;
        let ultimoAnguloDetectado = 0;
        let tocando = false;
        const LIMITE_ROTAÇÃO = 450; // 450 para cada lado (900 total)

        // --- FUNÇÃO DE LAYOUT ---
        function mudarLayout() {
            if (app.classList.contains('horizontal')) {
                app.classList.remove('horizontal');
                app.classList.add('vertical');
            } else {
                app.classList.remove('vertical');
                app.classList.add('horizontal');
            }
        }

        // --- LÓGICA DO VOLANTE ---
        areaVolante.addEventListener('touchstart', (e) => {
            tocando = true;
            let toque = e.touches[0];
            ultimoAnguloDetectado = calcularAnguloToque(toque.clientX, toque.clientY);
        });

        areaVolante.addEventListener('touchend', () => {
            tocando = false;
            // Opcional: Auto-center (voltar ao meio sozinho)
            // Se quiser que o volante fique onde parou, comente a linha abaixo:
            animarRetornoAoCentro();
        });

        document.addEventListener('touchmove', (e) => {
            if (!tocando) return;
            e.preventDefault(); // Evita scroll da tela

            let toque = e.touches[0];
            let anguloAtual = calcularAnguloToque(toque.clientX, toque.clientY);
            
            // Calcula a diferença (Delta)
            let delta = anguloAtual - ultimoAnguloDetectado;

            // Corrige a passagem pelo ponto de corte (180 -> -180)
            if (delta > 180) delta -= 360;
            if (delta < -180) delta += 360;

            anguloTotal += delta;

            // Trava nos limites (Simulação de fim de curso)
            if (anguloTotal > LIMITE_ROTAÇÃO) anguloTotal = LIMITE_ROTAÇÃO;
            if (anguloTotal < -LIMITE_ROTAÇÃO) anguloTotal = -LIMITE_ROTAÇÃO;

            ultimoAnguloDetectado = anguloAtual;
            atualizarVisual();
            enviarDados();
        }, { passive: false });

        function calcularAnguloToque(x, y) {
            let rect = volanteVisual.getBoundingClientRect();
            let centroX = rect.left + rect.width / 2;
            let centroY = rect.top + rect.height / 2;
            
            // Math.atan2(y, x) -> Retorna radianos
            let rad = Math.atan2(y - centroY, x - centroX);
            let deg = rad * (180 / Math.PI);
            return deg;
        }

        function atualizarVisual() {
            // Gira o visual
            volanteVisual.style.transform = `rotate(${anguloTotal}deg)`;
            textoGraus.innerText = Math.round(anguloTotal) + "°";
        }

        function animarRetornoAoCentro() {
            // Efeito simples de voltar suavemente
            let intervalo = setInterval(() => {
                if (tocando) { clearInterval(intervalo); return; }
                
                if (Math.abs(anguloTotal) < 1) {
                    anguloTotal = 0;
                    atualizarVisual();
                    enviarDados();
                    clearInterval(intervalo);
                } else {
                    anguloTotal = anguloTotal * 0.8; // Volta 20% a cada frame
                    atualizarVisual();
                    enviarDados();
                }
            }, 30);
        }

        // --- LÓGICA PEDAIS ---
        let estadoPedais = { acelerador: false, freio: false };
        const btnAcel = document.getElementById('acelerador');
        const btnFreio = document.getElementById('freio');

        function configurarPedal(elem, tipo) {
            elem.addEventListener('touchstart', (e) => { 
                e.preventDefault(); 
                elem.classList.add('pressionado'); 
                estadoPedais[tipo] = true; 
                enviarDados(); 
            });
            elem.addEventListener('touchend', (e) => { 
                e.preventDefault(); 
                elem.classList.remove('pressionado'); 
                estadoPedais[tipo] = false; 
                enviarDados(); 
            });
        }
        configurarPedal(btnAcel, 'acelerador');
        configurarPedal(btnFreio, 'freio');

        // --- COMUNICAÇÃO ---
        function enviarDados() {
            if (ws.readyState === WebSocket.OPEN) {
                let payload = {
                    angulo: anguloTotal,
                    acelerador: estadoPedais.acelerador,
                    freio: estadoPedais.freio
                };
                ws.send(JSON.stringify(payload));
            }
        }
    </script>
</body>
</html>